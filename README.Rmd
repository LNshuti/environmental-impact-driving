---
title: "README"
author: "Leonce Nshuti"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
# Load necessary libraries and functions
library(finnts)
library(data.table)
library(tidygraph)
library(gt)
library(tidyverse)
```

```{r}
# This function remove unnecessary axes from shape maps
remove_all_axes <- ggplot2::theme(
  axis.text = ggplot2::element_blank(),
  axis.line = ggplot2::element_blank(),
  axis.ticks = ggplot2::element_blank(),
  panel.border = ggplot2::element_blank(),
  panel.grid = ggplot2::element_blank(),
  axis.title = ggplot2::element_blank(),
  rect = element_blank(), 
  plot.background = element_blank()
)

my_theme <- theme_classic(base_family = "Times") +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.line.y = element_blank()) +
  theme(legend.background = element_rect(fill = "gainsboro")) 
```


```{r}
source("R/data_aggregation_task.R")
```

```{r}
sitc_xwalk <-
  readxl::read_xls("dataverse_files/SITCProducts.xls") %>%
  janitor::clean_names()

rwa_sum <-
  read_rds("GreenAutoImpact.github.io/inputs/rwanda_trade_df_1999_2019.rds") %>%
  left_join(sitc_xwalk, by = c("sitc_product_code"= "product_code")) %>%
  rename(product_name = product_description) %>%
  mutate(product_name = str_to_lower(product_name)) %>%
  mutate(product_name = ifelse(grepl("gold", product_name),"gold non-monetary", product_name)) %>% 
  mutate(product_name = ifelse(grepl("cement", product_name),"cement",product_name)) %>% 
  mutate(product_name = ifelse(grepl("medicaments", product_name),"medicaments",product_name)) %>% 
  mutate(product_name = ifelse(grepl("vaccines", product_name),"medicaments",product_name)) %>% 
  
  mutate(product_name = ifelse(grepl("aircraft", product_name),"aircraft",product_name)) %>%
  mutate(product_name = ifelse(grepl("aircrft", product_name),"aircraft",product_name)) %>%
  mutate(product_name = ifelse(grepl("special transactions", product_name),
                               "special transactions",product_name)) %>%
  mutate(import_value = as.numeric(import_value)) %>%
  group_by(year, product_name) %>%
  summarize(import_value = sum(import_value, na.rm = T)) %>% 
  arrange(desc(import_value)) %>%
  ungroup() %>% 
  mutate(year =  as.Date(as.character(year), format = "%Y"))

rwa_sum_rank <-
  rwa_sum %>%
  mutate(year = lubridate::year(year)) %>%
  filter(year > 2010) %>%
  # select(-sitc_product_code, -nomenclature_code, -tier) %>%
  group_by(year) %>%  
  arrange(year, desc(import_value)) %>%  
  # assign ranking
  mutate(rank = 1:n()) %>%  
  filter(rank <= 10) %>%
  ungroup() %>%
  gt::gt()

# library(gt)
# gtsave(rwa_sum_rank, "GreenAutoImpact.github.io/plots/rwa_sum_rank.png")

rwa_sum_rank_plt <- 
  rwa_sum %>%  
  ggplot() +  
  aes(xmin = 0,  xmax = import_value / 1000000) +  
  aes(ymin = rank - .45, ymax = rank + .45, y = rank) +  
  facet_wrap(~ year) +  
  geom_rect(alpha = .7) +  
  aes(fill = product_name) +  
  scale_fill_viridis_d(option = "magma", direction = -1) +
  labs(x = 'Imports (millions)', fill = "Product category", y ="") +
  scale_x_continuous(  
    limits = c(0, 800),  
    breaks = c(0, 400,  800)) +
  my_theme

ggsave(rwa_sum_rank_plt,
       filename = "GreenAutoImpact.github.io/plots/rwanda_imports.png",
       width = 6, 
       height = 4)

```

```{r}
# Model 1: auto_arima ----
model_fit_arima_no_boost <- arima_reg() %>%
  set_engine(engine = "auto_arima") %>%
  fit(import_value ~ year+ factor(product_name, label = TRUE),
      data = rwa_sum)

# Model 4: prophet ----
model_fit_prophet <- prophet_reg() %>%
  set_engine(engine = "prophet") %>%
  fit(import_value ~ year, data = rwa_sum)

models_tbl <- 
  modeltime_table(model_fit_prophet)

models_tbl %>%
  modeltime_forecast(
    actual_data = rwa_sum
  ) %>%
  plot_modeltime_forecast(.legend_max_width = 25, # For mobile screens
    .interactive      = interactive
  )

```
