---
title: "README"
author: "Leonce Nshuti"
output: html_document
---

```{r setup, include=FALSE}
repo_ <- "environmental-impact-driving"
source(paste0(repo_, "/R/manifest.R"))
#source("R/data_aggregation_task.R")

sitc_xwalk <-
  read_csv(paste0(repo_,"/inputs/sitc_product_code.csv")) %>%
  janitor::clean_names() %>%
  mutate(product_code = str_pad(product_code, width = 5, side = c("left"), pad = "0"))

rwa_sum <-
  read_rds(paste0(repo_, "/inputs/rwanda_trade_df_1999_2019.rds")) %>%
  mutate(sitc_product_code = str_pad(sitc_product_code,
                                     width = 5, side = c("left"), pad = "0")) %>%
  left_join(sitc_xwalk, by = c("sitc_product_code"= "product_code")) %>%
  rename(product_name = product_description) %>%
  mutate(import_value = as.numeric(import_value),
         product_name = str_to_lower(product_name),
         export_value = as.numeric(export_value)) %>%
  mutate(year =  as.Date(as.character(year), format = "%Y")) %>%
  mutate(year = lubridate::year(year)) #%>%
  #sample_n(10000)

rwa_summary <-
  rwa_sum %>% 
  group_by(product_name, year, location_id, partner_id, product_id) %>%
  summarise(imports = sum(import_value, na.rm = TRUE),
            exports = sum(export_value, na.rm = TRUE)) %>%
  ungroup() %>%
  rename(name = product_name) %>%
  mutate(name = ifelse(grepl("gold|mineraks|aluminium|iron/st|steel|minerals", name), " metals", name)) %>%
  mutate(name = ifelse(grepl("cement", name), "cement", name)) %>%
  mutate(name = ifelse(grepl("kraft uncoat|printed matter|book|typewrirers", name), "books & paper", name)) %>%
  mutate(name = ifelse(grepl("clothing ", name), "clothing",name)) %>%
  mutate(name = ifelse(grepl("aircraft|aircrft|airplanes", name), "aircrafts", name)) %>%
  mutate(name = ifelse(grepl("special tra|un special code", name), "special transactions", name)) %>%
  mutate(name = ifelse(grepl("communication|radio|telecom|telephone|computers", name), "telecom", name)) %>%
  mutate(name = ifelse(grepl("petroleum|petrol|crude oil|liquid propane", name), "petroleum", name)) %>%
  mutate(name = ifelse(grepl("lifting|constr/mining|pulley", name), "construction", name)) %>%
  mutate(name = ifelse(grepl("medicaments|glycosides|x-ray", name), "healthcare goods", name)) %>%
  mutate(name = ifelse(grepl("furniture", name), "furniture",name)) %>%
  mutate(name = ifelse(grepl("plastic", name), "plastic",name)) %>%
  mutate(name = ifelse(grepl("batteries", name), "batteries",name)) %>%
  mutate(name = ifelse(grepl("leather", name), "leather",name)) %>%
  mutate(name = ifelse(grepl("fertilizers", name), "fertilizers",name)) %>%
  mutate(name = ifelse(grepl("vehicles|passenger|tyres|tires|motorcycles|buses|semi-trailer", name), "vehicles & parts", name)) %>%
  mutate(name = ifelse(grepl("beans|legumes|cane|wheat|corn|maize|sugar|soy|meal|cereal|hydrogenated|beet|chocolate|food|strawberries|fish|ruit fresh|beef|groundnuts|nutmeg|milk|salt|vegetables|rice|beer|fixed veg oils|whey|mutton|spices",
                             name), "food products", name)) %>%
  mutate(name = str_trim(name)) %>%
  mutate(len_name = str_length(name)) %>%
  group_by(year) %>%  
  arrange(year, desc(imports)) %>%  
  filter(!is.na(name)) %>%
  # assign ranking
  mutate(rank = 1:n()) %>%  
  ungroup() 

write_rds(x = rwa_summary, file = "rwandatrade/processed/rwa_summary.rds")
write_rds(x = rwa_summary, file = "rwandatrade/processed/rwa_summary.csv")
```

```{r}
rwa_sum_features <- 
  rwa_summary %>% 
  filter(name %in% c("metals", "food products", "fertilizers", "books & paper", "aircrafts", "leather", "healthcare goods",
                     "plastic", "construction", "telecom", "vehicles & parts", "cement", "special transactions", "petroleum",
                     "clothing")) 
  
write_csv(x = rwa_sum_features, file = "rwandatrade/processed/rwa_sum_features.rds")
write_csv(x = rwa_sum_features, file = "rwandatrade/processed/rwa_sum_features.csv")
```



```{r}
rwa_sum_rank_plt <- 
  rwa_sum_features %>%
  #filter(year > 2010 & rank < 6) %>%
  ggplot() +  
  aes(xmin = 0,  xmax = log(imports)) +  
  aes(ymin = rank - 0.5, ymax = rank + 0.5, y = rank) +  
  facet_wrap(~ year) +  
  geom_rect(alpha = .7) +  
  aes(fill = name) +  
  #scale_fill_viridis_d(option = "magma", direction = -1) +
  labs(x = 'Imports (millions)', fill = "Product category", y ="") +
  #scale_x_continuous(limits = c(0, 500), breaks = c(0,250,500)) +
  my_theme + 
  theme_bw() +
  theme_tufte_revised() 

ggsave(rwa_sum_rank_plt,width = 10, height = 6,
       filename = "rwandatrade/output/rwanda_imports.png")
```
