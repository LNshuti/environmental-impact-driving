---
title: "README"
author: "Leonce Nshuti"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
# Load necessary libraries and functions
library(finnts)
library(data.table)
library(tidygraph)
library(gt)
library(tidyverse)
```

```{r}
theme_tufte_revised <- function(base_size = 11, base_family = "Gill Sans", ticks = TRUE) {
  
  ret <- ggplot2::theme_bw(base_family = base_family, base_size = base_size) +
    ggplot2::theme(
      axis.line = ggplot2::element_line(color = 'black'),
      axis.title.x = ggplot2::element_text(vjust = -0.3),
      axis.title.y = ggplot2::element_text(vjust = 0.8),
      legend.background = ggplot2::element_blank(),
      legend.key = ggplot2::element_blank(),
      legend.title = ggplot2::element_text(face="plain"),
      panel.background = ggplot2::element_blank(),
      panel.border = ggplot2::element_blank(),
      panel.grid = ggplot2::element_blank(),
      plot.background = ggplot2::element_blank(),
      strip.background = ggplot2::element_blank()
    )
  
  if (!ticks) {
    ret <- ret + ggplot2::theme(axis.ticks = ggplot2::element_blank())
  }
  
  ret
}


my_theme <- 
  theme_classic(base_family = "Times") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border = ggplot2::element_blank(),
        panel.grid = ggplot2::element_blank(),
        axis.line.y = element_blank(), 
        legend.background = element_rect()
        ) 
```


```{r}
#source("R/data_aggregation_task.R")
```

```{r}
sitc_xwalk <-
  readxl::read_xls("dataverse_files/SITCProducts.xls") %>%
  janitor::clean_names()
```


```{r}
rwa_sum <-
  read_rds("GreenAutoImpact.github.io/inputs/rwanda_trade_df_1999_2019.rds") %>%
  left_join(sitc_xwalk, by = c("sitc_product_code"= "product_code")) %>%
  rename(product_name = product_description) %>%
  select(product_name,import_value,year) %>%
  unique() %>%
  mutate(product_name = str_to_lower(product_name)) %>%
  mutate(product_name = ifelse(grepl("gold", product_name),"gold, non-monetary", product_name)) %>% 
  mutate(product_name = ifelse(grepl("cement", product_name),"cement",product_name)) %>% 
  mutate(product_name =  ifelse(grepl(paste(c("aircraft", "aircrft", "airplanes"), collapse="|"),
                                      product_name), "aircrafts", product_name)) %>%
  mutate(product_name =  ifelse(grepl(paste(c("special tra", "un special code"), collapse="|"),
                                      product_name), "special transactions", product_name)) %>%
  
  mutate(product_name = ifelse(grepl(paste(c("medicaments", "glycosides", "vaccines"), collapse="|"),
                                     product_name), "healthcare goods", product_name)) %>%
  mutate(product_name = ifelse(grepl("clothing ", product_name), "clothing",product_name)) %>%
  mutate(product_name =  ifelse(grepl(paste(c("communication", "radio", "telecom"), collapse="|"),
                                      product_name), "telecom", product_name)) %>%
  mutate(product_name =  ifelse(grepl(paste(c("petroleum", "petrol.", "crude oil"), collapse="|"),
                                      product_name), "petroleum", product_name)) %>%
  mutate(product_name =  ifelse(grepl(paste(c("beans", "legumes", "vegetables","cane sugar", "wheat",
                                              "corn", "maize", "sugar", "soy", "sugar", "meal", "cereal",
                                              "hydrogenated oils", "animal", "beet", "chocolate", "food"),
                                            collapse="|"), product_name), "food products", product_name)) %>%
  mutate(product_name =  ifelse(grepl(paste(c("lifting", "constr/mining", "pulley"), collapse="|"),
                                      product_name), "construction", product_name)) %>%
  mutate(product_name = ifelse(grepl("vehicles", product_name), "motor vehicles",product_name)) %>%
  mutate(product_name = ifelse(grepl("passenger", product_name), "motor vehicles",product_name)) %>%
  mutate(product_name = ifelse(grepl("batteries", product_name), "batteries",product_name)) %>%
  mutate(product_name = ifelse(grepl("furniture", product_name), "furniture",product_name)) %>%
  mutate(product_name = ifelse(grepl("leather", product_name), "leather",product_name)) %>%
  mutate(product_name = ifelse(grepl("fertilizers", product_name), "fertilizers",product_name)) %>%
  mutate(import_value = as.numeric(import_value)) %>%
  group_by(year, product_name) %>%
  summarize(import_value = sum(import_value, na.rm = T)) %>% 
  arrange(desc(import_value)) %>%
  ungroup() %>% 
  mutate(year =  as.Date(as.character(year), format = "%Y")) %>%
  mutate(year = lubridate::year(year)) %>%
  group_by(year) %>%  
  arrange(year, desc(import_value)) %>%  
  filter(!is.na(product_name)) %>%
  # assign ranking
  mutate(rank = 1:n()) %>%  
  ungroup() 
```


```{r}
rwa_sum_rank_plt <- 
  rwa_sum %>%
  filter(year > 2010 & rank < 6) %>%
  ggplot() +  
  aes(xmin = 0,  xmax = import_value / 1000000) +  
  aes(ymin = rank - 0.5, ymax = rank + 0.5, y = rank) +  
  facet_wrap(~ year) +  
  geom_rect(alpha = .7) +  
  aes(fill = product_name) +  
  #scale_fill_viridis_d(option = "magma", direction = -1) +
  labs(x = 'Imports (millions)', fill = "Product category", y ="") +
  scale_x_continuous(limits = c(0, 800), breaks = c(0,400,800)) +
  my_theme + 
  theme_tufte_revised()

ggsave(rwa_sum_rank_plt,width = 8, height = 4,
       filename = "GreenAutoImpact.github.io/plots/rwanda_imports.png")
```

```{r}
# Model 1: auto_arima ----
model_fit_arima_no_boost <- arima_reg() %>%
  set_engine(engine = "auto_arima") %>%
  fit(import_value ~ year+ factor(product_name, label = TRUE),
      data = rwa_sum)

# Model 4: prophet ----
model_fit_prophet <- prophet_reg() %>%
  set_engine(engine = "prophet") %>%
  fit(import_value ~ year, data = rwa_sum)

models_tbl <- 
  modeltime_table(model_fit_prophet)

models_tbl %>%
  modeltime_forecast(
    actual_data = rwa_sum
  ) %>%
  plot_modeltime_forecast(.legend_max_width = 25, # For mobile screens
    .interactive      = interactive
  )

```
